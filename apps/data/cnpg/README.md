# CloudNativePG (CNPG) - Postgres GitOps Base

This directory provides the **base** manifests for installing the CNPG operator and a highly available Postgres cluster. It is designed to be consumed by Argo CD as a Kustomize application, with environment-specific overlays under `clusters/`.

## What this base includes

- CNPG operator installation (remote manifest pinned to `v1.22.0`).
- A 3-instance Postgres cluster (`platform-postgres`) in the `data-system` namespace.
- Anti-affinity to spread replicas across nodes.
- Node **preference** for `workload=db` nodes using node affinity.
- Logical backup CronJob writing to a PVC.
- SealedSecret placeholder for application credentials (`platform-postgres-app`).

## Argo CD usage

Point an Argo CD Application at one of the environment overlays (recommended), e.g.:

- `clusters/local` for k3s + Longhorn.
- `clusters/cloud` for cloud overlays (scaffold; customize resources/storage).

Example (app-of-apps later):

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: data-cnpg
spec:
  source:
    repoURL: https://github.com/<org>/toolsuite-platform-gitops
    path: clusters/local
    targetRevision: main
    kustomize: {}
  destination:
    server: https://kubernetes.default.svc
    namespace: argocd
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
```

## Verification

After Argo CD sync (or `kustomize build clusters/local | kubectl apply -f -`):

```bash
kubectl get pods -n cnpg-system
kubectl get pods -n data-system
kubectl get cluster -n data-system
kubectl get services -n data-system | grep platform-postgres
kubectl get cronjob -n data-system
```

CNPG automatically creates services:

- `platform-postgres-rw` (read/write primary)
- `platform-postgres-ro` (read-only)

## Credentials strategy

- **Superuser** credentials are generated by CNPG and stored in the secret:
  - `platform-postgres-superuser` (auto-created by the operator).
- **Application** credentials are managed via a SealedSecret placeholder in this repo:
  - `platform-postgres-app` (replace `encryptedData` with your sealed values).

### Creating the SealedSecret

```bash
kubectl create secret generic platform-postgres-app \
  -n data-system \
  --from-literal=username=platform \
  --from-literal=password='<strong-password>' \
  --dry-run=client -o yaml \
  | kubeseal --format=yaml > apps/data/cnpg/sealedsecret-app.yaml
```

## Backups

A logical backup CronJob runs nightly and stores dumps in the PVC `platform-postgres-backups`.

### Restore procedure

1. Identify the backup file in the PVC:
   ```bash
   kubectl exec -n data-system deploy/platform-postgres-1 -- ls -lh /backups
   ```
2. Copy the file locally (optional):
   ```bash
   kubectl cp data-system/<backup-pod>:/backups/cluster-<timestamp>.sql ./cluster.sql
   ```
3. Restore into the primary:
   ```bash
   kubectl exec -n data-system -it <primary-pod> -- psql -U postgres -f /backups/cluster-<timestamp>.sql
   ```

> Tip: you can also attach the backup PVC to a temporary job or pod for inspection.
