apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: platform-postgres
  labels:
    app.kubernetes.io/name: platform-postgres
    app.kubernetes.io/part-of: data-platform
spec:
  instances: 3
  imageName: ghcr.io/cloudnative-pg/postgresql:16.4
  storage:
    size: 20Gi
    storageClass: standard
  bootstrap:
    initdb:
      database: platform
      owner: platform
      secret:
        name: platform-postgres-app
  affinity:
    podAntiAffinityType: preferred
    topologyKey: kubernetes.io/hostname
  podTemplate:
    metadata:
      labels:
        app.kubernetes.io/name: platform-postgres
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: workload
                    operator: In
                    values:
                      - db
